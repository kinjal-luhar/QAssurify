<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QAssurify — Turning QA into Confidence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/qassurify.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0A1F44; /* Navy */
            --secondary-color: #1E3A8A; /* Royal Blue */
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #4B5563; /* Slate Gray */
            --light-color: #FFFFFF; /* White */
        }

        body {
            background: var(--light-color);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: #FFFFFF;
            border: 1px solid rgba(176,190,197,0.6);
            border-radius: 20px;
            box-shadow: 0 12px 32px rgba(10, 31, 68, 0.08);
            margin: 20px;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 28px 0;
            background: var(--primary-color);
            color: #FFFFFF;
            border-radius: 16px;
        }

        .header h1 {
            color: #FFFFFF;
            font-weight: 800;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        .header p {
            color: #E6EDF5;
            font-size: 1.05em;
            margin: 0;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f1c40f);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .stats-card {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #fff, #f8f9fa);
        }

        .stats-number {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stats-label {
            font-size: 1.1em;
            color: var(--dark-color);
            font-weight: 500;
        }

        .progress {
            height: 25px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            border-radius: 15px;
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            transition: width 0.5s ease;
        }

        .test-pass {
            background-color: rgba(40, 167, 69, 0.1);
        }

        .test-fail {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .test-bug {
            background-color: rgba(255, 193, 7, 0.1);
        }

        .table-sm td {
            padding: 8px 12px;
            vertical-align: middle;
        }

        .table-sm th {
            padding: 12px;
            font-weight: 600;
            background-color: #f8f9fa;
        }

        .result-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .severity-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .severity-high {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
        }

        .severity-medium {
            background: linear-gradient(135deg, var(--warning-color), #f1c40f);
            color: white;
        }

        .severity-low {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
        }

        .severity-critical {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .download-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .filename-input {
            border-radius: 25px;
            border: 2px solid #dee2e6;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .filename-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .alert {
            border-radius: 15px;
            border: none;
            padding: 20px;
            margin: 20px 0;
        }

        .table {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 20px 15px;
            font-weight: 600;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-color: #dee2e6;
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 20px 20px 0 0;
            border: none;
        }

        .modal-body {
            padding: 30px;
        }

        .form-control {
            border-radius: 25px;
            border: 2px solid #dee2e6;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .form-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .badge {
            font-size: 0.9em;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container-fluid qs-container">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1>QAssurify</h1>
                <p>Turning QA into Confidence</p>
            </div>

            <!-- Control Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs"></i> Test Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Target URL</label>
                                        <input type="text" class="form-control" id="targetUrl" 
                                               value="http://127.0.0.1:8000" 
                                               placeholder="Enter the URL to test">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Test Modules</label>
                                        <select class="form-control" id="testModules" multiple>
                                            <option value="all" selected>All Tests</option>
                                            <option value="tests.test_signup">Signup Tests</option>
                                            <option value="tests.test_login">Login Tests</option>
                                            <option value="tests.test_navigation">Navigation Tests</option>
                                            <option value="tests.test_forms">Form Tests</option>
                                            <option value="tests.test_api">API Tests</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center d-flex flex-wrap gap-2 justify-content-center">
                                <button class="btn btn-primary btn-lg" id="runTestsBtn" onclick="runTests()">
                                    <i class="fas fa-play"></i> Run Tests
                                </button>
                                <button class="btn btn-warning btn-lg ms-2" id="stopTestsBtn" onclick="stopTests()" style="display: none;">
                                    <i class="fas fa-stop"></i> Stop Tests
                                </button>
                                <button class="btn btn-outline-secondary btn-lg" id="clearResultsBtn" onclick="clearResults()">
                                    <i class="fas fa-rotate"></i> Clear Results
                                </button>
                                <div class="ms-2">
                                    <label class="form-label">Upload Existing Report</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="reportFile" accept=".xlsx,.xls,.csv">
                                        <button class="btn btn-secondary" onclick="uploadReport()"><i class="fas fa-upload"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="row mb-4" id="progressSection" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Test Execution Progress</h6>
                            <div class="progress">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <span id="progressText">Preparing tests...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Dashboard (4 KPIs in one row on lg screens) -->
            <div class="row g-2 mb-3" id="statsSection" style="display: none;">
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center">
                        <div class="stats-number text-primary" id="totalTests">0</div>
                        <div class="stats-label">Total Tests</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center">
                        <div class="stats-number text-success" id="passedTests">0</div>
                        <div class="stats-label">Passed</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center">
                        <div class="stats-number text-danger" id="failedTests">0</div>
                        <div class="stats-label">Failed</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center">
                        <div class="stats-number text-warning" id="bugCount">0</div>
                        <div class="stats-label">Bugs Found</div>
                    </div>
                </div>
            </div>

            <!-- Insights Charts Row -->
            <div class="row g-3 mb-3" id="insightsRow" style="display: none;">
                <div class="col-12 col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-circle-notch"></i> Results Distribution</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container compact">
                                <canvas id="resultsPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-layer-group"></i> Test Types</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container compact">
                                <canvas id="typesBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-triangle-exclamation"></i> Severity</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container compact">
                                <canvas id="severityPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            

            <!-- Download Section (visible; buttons enabled after results) -->
                            <div class="row mb-3" id="downloadSection">
                <div class="col-12">
                    <div class="download-section">
                        <h5><i class="fas fa-download"></i> Download Reports</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Excel Report</label>
                                    <div class="input-group">
                                                        <input type="text" class="form-control filename-input" id="excelFilename" 
                                                               placeholder="qa_report_YYYYMMDD">
                                                        <button class="btn btn-success" id="excelBtn" onclick="downloadExcel()">
                                            <i class="fas fa-file-excel"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">CSV Report</label>
                                    <div class="input-group">
                                                        <input type="text" class="form-control filename-input" id="csvFilename" 
                                                               placeholder="qa_report_YYYYMMDD">
                                                        <button class="btn btn-info" id="csvBtn" onclick="downloadCSV()">
                                            <i class="fas fa-file-csv"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Summary Report</label>
                                    <div class="input-group">
                                                        <input type="text" class="form-control filename-input" id="summaryFilename" 
                                                               placeholder="qa_summary_YYYYMMDD">
                                                        <button class="btn btn-warning" id="summaryBtn" onclick="downloadSummary()">
                                            <i class="fas fa-file-alt"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div class="row" id="testRunsSection" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex flex-wrap align-items-center w-100 gap-2">
                                <h5 class="mb-0"><i class="fas fa-list"></i> Test Runs</h5>
                                <div class="ms-auto d-flex flex-wrap gap-2">
                                    <input class="form-control form-control-sm" id="searchInput" placeholder="Search case/details">
                                    <select class="form-select form-select-sm" id="filterStatus">
                                        <option value="">All Status</option>
                                        <option value="PASS">PASS</option>
                                        <option value="FAIL">FAIL</option>
                                        <option value="BUG">BUG</option>
                                    </select>
                                    <select class="form-select form-select-sm" id="filterType">
                                        <option value="">All Types</option>
                                        <option>UI</option>
                                        <option>Form</option>
                                        <option>API</option>
                                        <option>Navigation</option>
                                        <option>Security</option>
                                        <option>Performance</option>
                                        <option>System</option>
                                    </select>
                                    <select class="form-select form-select-sm" id="filterSeverity">
                                        <option value="">All Severity</option>
                                        <option>Low</option>
                                        <option>Medium</option>
                                        <option>High</option>
                                        <option>Critical</option>
                                    </select>
                                    <select class="form-select form-select-sm" id="pageSize">
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()"><i class="fas fa-filter"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="loadingSpinner" class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Running tests...</p>
                            </div>
                            <div id="testResults" style="display: none;">
                                <!-- Test results will be populated here -->
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2" id="pager" style="display:none;">
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="prevPage" onclick="changePage(-1)">Prev</button>
                                    <button class="btn btn-sm btn-outline-secondary" id="nextPage" onclick="changePage(1)">Next</button>
                                </div>
                                <div id="pageInfo" class="text-muted"></div>
                                <div>
                                    <button class="btn btn-sm btn-outline-info" onclick="downloadCSVFiltered()"><i class="fas fa-file-csv"></i> Download Filtered CSV</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Viewer -->
            <div class="row g-3 mb-3" id="dataViewerSection">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex align-items-center w-100">
                                <h6 class="mb-0"><i class="fas fa-database"></i> Test Data Viewer</h6>
                                <div class="ms-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadSampleData()"><i class="fas fa-eye"></i> View Generated Sample</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleDataFormat()"><i class="fas fa-code"></i> Toggle JSON/Table</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="dataViewerInfo" class="text-muted mb-2">Load to preview the sample data used for tests (valid/invalid, contacts, edge cases).</div>
                            <pre id="dataViewerJson" class="bg-light p-3 rounded" style="display:none; white-space: pre-wrap;"></pre>
                            <div id="dataViewerTable"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Progress Modal -->
    <div class="modal fade" id="downloadProgressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-download"></i> Downloading Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <span id="downloadProgressLabel">Preparing...</span>
                        <span id="downloadProgressPct">0%</span>
                    </div>
                    <div class="progress">
                        <div id="downloadProgressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script>
        let testInterval;
        let passRateChart, securityChart;
        let resultsPieChart, typesBarChart, severityPieChart;
        let currentPage = 1;
        let totalItems = 0;
        let pageSize = 50;
        let lastQuery = {};

            // Initialize charts
        function initCharts() {
            // Pass Rate Chart
            const passRateCtx = document.getElementById('passRateChart').getContext('2d');
            passRateChart = new Chart(passRateCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Failed', 'Bugs'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Security Chart
            const securityCtx = document.getElementById('securityChart').getContext('2d');
            securityChart = new Chart(securityCtx, {
                type: 'bar',
                data: {
                    labels: ['Security Tests'],
                    datasets: [{
                        label: 'Pass Rate (%)',
                        data: [0],
                        backgroundColor: '#3498db',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            // Ensure charts show initial empty state visibly
            try { passRateChart.update(); } catch(e){}
            try { securityChart.update(); } catch(e){}

            // Results Distribution Chart
            try {
                const resultsCtx = document.getElementById('resultsPieChart').getContext('2d');
                resultsPieChart = new Chart(resultsCtx, {
                    type: 'doughnut',
                    data: { labels: ['PASS','FAIL','BUG'], datasets: [{ data: [0,0,0], backgroundColor: ['#27ae60','#e74c3c','#f39c12'], borderWidth: 0 }]},
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch(e){}

            // Types Bar Chart
            try {
                const typesCtx = document.getElementById('typesBarChart').getContext('2d');
                typesBarChart = new Chart(typesCtx, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Count', data: [], backgroundColor: '#1E3A8A' }]},
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch(e){}

            // Severity Pie Chart
            try {
                const sevCtx = document.getElementById('severityPieChart').getContext('2d');
                severityPieChart = new Chart(sevCtx, {
                    type: 'pie',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#8b5cf6','#ef4444','#f59e0b','#22c55e'] }]},
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch(e){}
        }

        // Run tests
        function runTests() {
            const url = document.getElementById('targetUrl').value;
            const modules = Array.from(document.getElementById('testModules').selectedOptions).map(option => option.value);
            
            if (!url) {
                alert('Please enter a target URL');
                return;
            }

            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('runTestsBtn').style.display = 'none';
            document.getElementById('stopTestsBtn').style.display = 'inline-block';
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('pager').style.display = 'none';
            currentPage = 1;

            // Start test execution
            fetch('/run_tests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    modules: modules
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    resetUI();
                } else {
                    // Start polling for results
                    testInterval = setInterval(checkTestStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting tests: ' + error);
                resetUI();
            });
        }

        // Check test status
        function checkTestStatus() {
            fetch('/test_status')
            .then(response => response.json())
            .then(data => {
                if (data.running) {
                    // Update progress
                    const progress = Math.min(data.progress || 0, 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = `Running tests... ${progress}%`;
                } else {
                    // Tests completed
                    clearInterval(testInterval);
                    loadTestResults();
                    resetUI();
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                clearInterval(testInterval);
                resetUI();
            });
        }

        // Load test results
        function loadTestResults(extraParams = {}) {
            const params = new URLSearchParams();
            const status = document.getElementById('filterStatus')?.value || '';
            const type = document.getElementById('filterType')?.value || '';
            const severity = document.getElementById('filterSeverity')?.value || '';
            const search = document.getElementById('searchInput')?.value || '';
            pageSize = parseInt(document.getElementById('pageSize')?.value || '50', 10);
            params.set('page', String(currentPage));
            params.set('page_size', String(pageSize));
            if (status) params.set('status', status);
            if (type) params.set('type', type);
            if (severity) params.set('severity', severity);
            if (search) params.set('search', search);
            Object.entries(extraParams || {}).forEach(([k,v])=>params.set(k, v));
            lastQuery = Object.fromEntries(params);
            fetch('/test_results?' + params.toString())
            .then(response => response.json())
            .then(data => {
                displayTestResults(data.results, data.summary);
                totalItems = data.total || (data.results?.length || 0);
                updatePager();
                updateCharts(data.summary);
                updateInsightsCharts();
                enableDownloads();
                // Ensure charts section is visible
                document.getElementById('insightsRow').style.display = 'block';
                // Force a resize twice to ensure visibility after layout changes
                setTimeout(() => { try { passRateChart.resize(); } catch(e){} try { securityChart.resize(); } catch(e){} }, 50);
                setTimeout(() => { try { passRateChart.update(); } catch(e){} try { securityChart.update(); } catch(e){} }, 200);
            })
            .catch(error => {
                console.error('Error loading results:', error);
            });
        }

        function applyFilters() {
            currentPage = 1;
            loadTestResults();
        }

        function changePage(delta) {
            const maxPage = Math.max(1, Math.ceil(totalItems / pageSize));
            const next = Math.min(maxPage, Math.max(1, currentPage + delta));
            if (next !== currentPage) {
                currentPage = next;
                loadTestResults();
            }
        }

        function updatePager() {
            const pager = document.getElementById('pager');
            const maxPage = Math.max(1, Math.ceil(totalItems / pageSize));
            if (totalItems > pageSize) {
                pager.style.display = 'flex';
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${maxPage} • ${totalItems} items`;
                document.getElementById('prevPage').disabled = currentPage <= 1;
                document.getElementById('nextPage').disabled = currentPage >= maxPage;
            } else {
                pager.style.display = 'none';
            }
        }

        // Display test results
        function displayTestResults(results, summary) {
            const container = document.getElementById('testResults');
            container.innerHTML = '';

            // Update statistics
            document.getElementById('totalTests').textContent = summary.total_tests;
            document.getElementById('passedTests').textContent = summary.passed;
            document.getElementById('failedTests').textContent = summary.failed;
            document.getElementById('bugCount').textContent = summary.bugs;
            document.getElementById('passRateDisplay').textContent = summary.pass_rate + '%';
            document.getElementById('securityRateDisplay').textContent = summary.security_percentage + '%';

            // Show statistics sections
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('rateSection').style.display = 'block';
            document.getElementById('testRunsSection').style.display = 'block';

            // Create compact table for test results
            const table = document.createElement('table');
            table.className = 'table table-hover table-sm';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Test Case</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Details</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="testResultsBody">
                </tbody>
            `;
            
            const tbody = table.querySelector('#testResultsBody');
            
            results.forEach(result => {
                const icon = result.Result === 'PASS' ? '✓' : 
                           result.Result === 'FAIL' ? '✗' : '!';
                
                const severityClass = `severity-${result.Severity.toLowerCase()}`;
                const resultClass = result.Result === 'PASS' ? 'text-success' : 
                                  result.Result === 'FAIL' ? 'text-danger' : 'text-warning';
                
                const row = document.createElement('tr');
                row.className = `test-${result.Result.toLowerCase()}`;
                row.innerHTML = `
                    <td><span class="${resultClass} fw-bold">${icon} ${result.Result}</span></td>
                    <td><strong>${result['Test Case']}</strong></td>
                    <td><span class="badge bg-secondary">${result['Test Type']}</span></td>
                    <td><span class="badge ${severityClass}">${result.Severity}</span></td>
                    <td><small>${result.Details}</small></td>
                    <td><small class="text-muted">${result.Timestamp}</small></td>
                `;
                
                tbody.appendChild(row);
            });
            
            container.appendChild(table);

            container.style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';

            // Update environment info
            try { document.getElementById('envTarget').textContent = new URL(document.getElementById('targetUrl').value).hostname; } catch (e) { document.getElementById('envTarget').textContent = 'localhost'; }
            document.getElementById('envTime').textContent = new Date().toLocaleString();
        }

        // Update charts
        function updateCharts(summary) {
            // Update pass rate chart
            passRateChart.data.datasets[0].data = [
                summary.passed,
                summary.failed,
                summary.bugs
            ];
            passRateChart.update();

            // Update security chart
            securityChart.data.datasets[0].data = [summary.security_percentage];
            securityChart.update();
        }

        async function updateInsightsCharts() {
            try {
                const res = await fetch('/charts_data');
                const d = await res.json();
                if (!d) return;
                // Results pie
                try {
                    const rc = d.results_pie || { labels: ['PASS','FAIL','BUG'], values: [0,0,0] };
                    resultsPieChart.data.labels = rc.labels;
                    resultsPieChart.data.datasets[0].data = rc.values;
                    resultsPieChart.update();
                } catch(e){}
                // Types bar
                try {
                    const tb = d.types_bar || { x: [], y: [] };
                    typesBarChart.data.labels = tb.x;
                    typesBarChart.data.datasets[0].data = tb.y;
                    typesBarChart.update();
                } catch(e){}
                // Severity pie
                try {
                    const sp = d.severity_pie || { labels: [], values: [] };
                    severityPieChart.data.labels = sp.labels;
                    severityPieChart.data.datasets[0].data = sp.values;
                    severityPieChart.update();
                } catch(e){}
            } catch(e) {}
        }

        // Download functions - robust, avoids popup blockers
        function sanitizeFilename(name) {
            // Remove characters not allowed in Windows filenames and trim
            return (name || '').replace(/[\\/:*?"<>|]+/g, '-').replace(/\s+/g, ' ').trim();
        }

        function getPickerTypesByExt(ext) {
            const map = {
                'xlsx': [{ description: 'Excel Workbook', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] } }],
                'csv': [{ description: 'CSV', accept: { 'text/csv': ['.csv'] } }],
                'xlsx_summary': [{ description: 'Excel Workbook', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] } }]
            };
            return map[ext] || [{ description: 'All Files', accept: { '*/*': ['.*'] } }];
        }

        async function downloadFile(url, filename, requiredExt) {
            const modalEl = document.getElementById('downloadProgressModal');
            const bsModal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
            const bar = document.getElementById('downloadProgressBar');
            const pctEl = document.getElementById('downloadProgressPct');
            const lblEl = document.getElementById('downloadProgressLabel');

            function setProgress(pct, label) {
                const v = Math.max(0, Math.min(100, Math.floor(pct)));
                bar.style.width = v + '%';
                pctEl.textContent = v + '%';
                if (label) lblEl.textContent = label;
            }

            try {
                setProgress(0, 'Requesting file...');
                bsModal.show();
                const response = await fetch(url);
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || ('HTTP ' + response.status));
                }

                const total = Number(response.headers.get('Content-Length')) || 0;
                const supportsFS = 'showSaveFilePicker' in window;
                let safe = sanitizeFilename(filename);
                const ext = (requiredExt || '').toLowerCase();
                if (ext && !new RegExp(`\\.${ext}$`, 'i').test(safe)) safe += `.${ext}`;

                if (supportsFS && response.body) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: safe,
                        types: getPickerTypesByExt(ext || (safe.endsWith('.csv') ? 'csv' : 'xlsx'))
                    });
                    const writable = await handle.createWritable();
                    const reader = response.body.getReader();
                    let received = 0;
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        received += value.byteLength;
                        await writable.write(value);
                        if (total > 0) setProgress((received / total) * 100, `Downloading... ${(received/1024/1024).toFixed(2)} MB / ${(total/1024/1024).toFixed(2)} MB`);
                        else setProgress(Math.min(99, received / (1024*1024) * 5), `Downloading... ${(received/1024/1024).toFixed(2)} MB`);
                    }
                    await writable.close();
                    setProgress(100, 'Completed');
                } else {
                    const reader = response.body ? response.body.getReader() : null;
                    let chunks = [];
                    let received = 0;
                    if (reader) {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            chunks.push(value);
                            received += value.byteLength;
                            if (total > 0) setProgress((received / total) * 100, `Downloading... ${(received/1024/1024).toFixed(2)} MB / ${(total/1024/1024).toFixed(2)} MB`);
                        }
                        const blob = new Blob(chunks);
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = safe;
                        document.body.appendChild(link);
                        link.click();
                        setTimeout(() => { URL.revokeObjectURL(link.href); link.remove(); }, 0);
                        setProgress(100, 'Completed');
                    } else {
                        const blob = await response.blob();
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = safe;
                        document.body.appendChild(link);
                        link.click();
                        setTimeout(() => { URL.revokeObjectURL(link.href); link.remove(); }, 0);
                        setProgress(100, 'Completed');
                    }
                }
            } catch (e) {
                alert('Download error: ' + e.message);
            } finally {
                setTimeout(() => { try { bsModal.hide(); } catch (_) {} }, 500);
            }
        }

        function downloadExcel() {
            const inputVal = document.getElementById('excelFilename').value || '';
            const base = sanitizeFilename(inputVal) || 'qa_report';
            const filename = /\.xlsx$/i.test(base) ? base : base + '.xlsx';
            downloadFile(`/download_report?filename=${encodeURIComponent(filename)}`, filename, 'xlsx');
        }

        function downloadCSV() {
            const filenameBase = sanitizeFilename(document.getElementById('csvFilename').value || ('qa_report_' + new Date().toISOString().slice(0,10)));
            const filename = /\.csv$/i.test(filenameBase) ? filenameBase : filenameBase + '.csv';
            const params = new URLSearchParams();
            if (lastQuery.status) params.set('status', lastQuery.status);
            if (lastQuery.type) params.set('type', lastQuery.type);
            if (lastQuery.severity) params.set('severity', lastQuery.severity);
            if (lastQuery.search) params.set('search', lastQuery.search);
            downloadFile(`/download_csv?filename=${encodeURIComponent(filename)}&${params.toString()}`, filename, 'csv');
        }

        function downloadSummary() {
            const filenameBase = sanitizeFilename(document.getElementById('summaryFilename').value || ('qa_summary_' + new Date().toISOString().slice(0,10)));
            const filename = /\.xlsx$/i.test(filenameBase) ? filenameBase : filenameBase + '.xlsx';
            downloadFile(`/download_summary?filename=${encodeURIComponent(filename)}`, filename, 'xlsx');
        }

        // Stop tests
        function stopTests() {
            fetch('/stop_tests', { method: 'POST' })
            .then(() => {
                clearInterval(testInterval);
                resetUI();
                alert('Stop requested. The agent will halt shortly.');
            })
            .catch(() => {
                clearInterval(testInterval);
                resetUI();
            });
        }

        // Reset UI
        function resetUI() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('runTestsBtn').style.display = 'inline-block';
            document.getElementById('stopTestsBtn').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
        }

            // Enable downloads after testing and set filenames by hostname (kept enabled, just update values)
        function enableDownloads() {
            const url = document.getElementById('targetUrl').value || '';
            let host = '';
            try { host = new URL(url).hostname.replace(/^www\./,''); } catch (e) { host = 'localhost'; }

            const now = new Date().toISOString().slice(0,10).replace(/-/g, '');
            const base = host ? host.replace(/[^a-zA-Z0-9_-]/g, '-') : 'localhost';

            const excel = document.getElementById('excelFilename');
            const csv = document.getElementById('csvFilename');
            const summary = document.getElementById('summaryFilename');
            if (excel) { excel.value = `${base}_qa_report_${now}`; }
            if (csv) { csv.value = `${base}_qa_report_${now}`; }
            if (summary) { summary.value = `${base}_qa_summary_${now}`; }

            const section = document.getElementById('downloadSection');
            if (section) section.style.display = 'block';
        }

        async function uploadReport() {
            const fileInput = document.getElementById('reportFile');
            const file = fileInput.files && fileInput.files[0];
            if (!file) { alert('Choose a report file'); return; }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch('/upload_report', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Upload failed');
                // show sections and load results
                document.getElementById('testRunsSection').style.display = 'block';
                document.getElementById('statsSection').style.display = 'block';
                applyFilters();
            } catch (e) {
                alert('Upload error: ' + e.message);
            }
        }

        async function clearResults() {
            try {
                await fetch('/clear_results', { method: 'POST' });
                document.getElementById('testResults').innerHTML = '';
                document.getElementById('statsSection').style.display = 'none';
            document.getElementById('insightsRow').style.display = 'none';
                document.getElementById('testRunsSection').style.display = 'none';
                document.getElementById('pager').style.display = 'none';
                currentPage = 1;
                totalItems = 0;
            } catch (e) {}
        }

        // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // Set default filenames
            const now = new Date().toISOString().slice(0,10).replace(/-/g, '');
            document.getElementById('excelFilename').value = `qa_report_${now}`;
            document.getElementById('csvFilename').value = `qa_report_${now}`;
            document.getElementById('summaryFilename').value = `qa_summary_${now}`;

            // Wire filters
            const inputs = ['searchInput','filterStatus','filterType','filterSeverity','pageSize'];
            inputs.forEach(id=>{
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', ()=>{ currentPage = 1; loadTestResults(); });
                if (id==='searchInput') el.addEventListener('input', ()=>{ currentPage = 1; loadTestResults(); });
            });

            // Helpers
            window.prefillLocalhost = function() {
                document.getElementById('targetUrl').value = 'http://127.0.0.1:8000';
            }
            window.prefillExample = function() {
                document.getElementById('targetUrl').value = 'https://example.com';
            }
            window.copySummary = function() {
                const total = document.getElementById('totalTests').textContent;
                const passed = document.getElementById('passedTests').textContent;
                const failed = document.getElementById('failedTests').textContent;
                const bugs = document.getElementById('bugCount').textContent;
                const passRate = document.getElementById('passRateDisplay').textContent;
                const secRate = document.getElementById('securityRateDisplay').textContent;
                const text = `QAssurify Summary\nTotal: ${total}, Passed: ${passed}, Failed: ${failed}, Bugs: ${bugs}\nPass Rate: ${passRate}, Security Pass: ${secRate}`;
                navigator.clipboard.writeText(text).then(()=>{
                    alert('Summary copied to clipboard');
                });
            }

            // Data Viewer controls
            window.toggleDataFormat = function(){
                const pre = document.getElementById('dataViewerJson');
                const tbl = document.getElementById('dataViewerTable');
                if (pre.style.display === 'none') { pre.style.display = 'block'; tbl.style.display='none'; }
                else { pre.style.display = 'none'; tbl.style.display='block'; }
            }
            window.loadSampleData = async function(){
                try {
                    const res = await fetch('/test_data_sample');
                    const d = await res.json();
                    if (!res.ok) throw new Error(d.error || 'Failed to load');
                    const obj = d.data || {};
                    const pre = document.getElementById('dataViewerJson');
                    pre.textContent = JSON.stringify(obj, null, 2);
                    pre.style.display = 'block';
                    const tbl = document.getElementById('dataViewerTable');
                    tbl.innerHTML = renderDataAsTable(obj);
                    tbl.style.display = 'none';
                    document.getElementById('dataViewerInfo').textContent = 'Sample data loaded.';
                } catch(e) {
                    alert('Error loading data: ' + e.message);
                }
            }
            window.renderDataAsTable = function(data){
                function toRows(key, val){
                    if (val && typeof val === 'object' && !Array.isArray(val)) {
                        return `<tr><th colspan="2" class="bg-light">${key}</th></tr>` + Object.keys(val).map(k=>toRows(k, val[k])).join('');
                    }
                    return `<tr><td class="fw-semibold">${key}</td><td><small>${String(val)}</small></td></tr>`;
                }
                const rows = Object.keys(data||{}).map(k=>toRows(k, data[k])).join('');
                return `<div class="table-responsive"><table class="table table-sm">${rows}</table></div>`;
            }
        });
    </script>
</body>
</html>
