<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QAssurify — QA Control Center</title>
    <link rel="stylesheet" href="/static/css/qassurify.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='10' ry='10' fill='%23E43636'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='28' fill='white'%3EQA%3C/text%3E%3C/svg%3E" />
    <style>
        :root{
            --red:#E43636;--cream:#F6EFD2;--beige:#E2DDB4;--black:#000;
        }
        html, body{width:100%}
        body{
            background:
                radial-gradient(1200px 600px at 100% -20%, rgba(228,54,54,.06), transparent 60%),
                radial-gradient(900px 500px at -10% 110%, rgba(226,221,180,.25), transparent 60%),
                linear-gradient(180deg, var(--cream), #fff);
            color:var(--black);
            font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin:0;overflow-x:hidden
        }
        .container{width:min(100vw,1400px);margin-inline:auto;padding:12px 40px}
        @media(min-width:1280px){.container{padding:12px 56px}}
        /* Pinned side navigation */
        .side-nav{position:fixed;top:60px;left:0;height:calc(100vh - 60px);width:220px;background:#fff;border-right:1px solid var(--beige);box-shadow:0 6px 20px rgba(0,0,0,.06);padding:12px;border-top-right-radius:12px;border-bottom-right-radius:12px;z-index:5;transform:translateX(0);transition:transform .28s ease}
        .side-nav.collapsed{transform:translateX(-230px)}
        .side-nav .toggle{position:absolute;right:-14px;top:10px;background:#fff;border:1px solid var(--beige);border-radius:20px;padding:6px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .side-nav h4{margin:6px 0 10px 0;font-size:12px;color:#555;text-transform:uppercase;letter-spacing:.04em}
        .side-nav a{display:block;padding:8px 10px;border-radius:10px;color:#000;text-decoration:none;font-size:13px;border:1px solid transparent}
        .side-nav a:hover{background:#faf8ef;border-color:var(--beige)}
        .side-nav hr{border:none;border-top:1px dashed var(--beige);margin:10px 0}
        .side-nav .sub{padding-left:10px}
        .with-sidenav{padding-left:250px;transition:padding-left .28s ease}
        .header-offset{padding-left:250px;transition:padding-left .28s ease}
        @media(max-width:960px){.side-nav{top:56px;width:200px}.with-sidenav{padding-left:0}.side-nav.collapsed{transform:translateX(-200px)}}
        header{position:sticky;top:0;z-index:10;background:var(--cream);display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:8px}
        .brand{display:flex;gap:12px;align-items:center;flex:1;min-width:0}
        .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--red),#b32020);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
        .title{font-size:20px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        /* Header hamburger */
        .hamburger-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--beige);border-radius:10px;background:#fff;cursor:pointer;margin-right:10px}
        .hamburger-btn:hover{background:#faf8ef}
        .hamburger-lines{display:inline-block;width:16px}
        .hamburger-lines span{display:block;height:2px;background:#000;margin:3px 0;border-radius:2px}
        .grid{display:grid;grid-template-columns:2fr 1fr;gap:24px;align-items:start}
        .grid.single{grid-template-columns:1fr;justify-items:center}
        @media(max-width:960px){.grid{grid-template-columns:1fr}}
        @media(max-width:960px){.grid{grid-template-columns:1fr}}
        .card{background:#fff;border:1px solid var(--beige);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
        .card h3{margin:0;padding:12px;border-bottom:1px solid var(--beige);font-size:16px}
        .card .body{padding:10px}
        .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media(min-width:900px){.controls{grid-template-columns:repeat(4,1fr)}}
        .opts{display:flex;gap:12px;align-items:center;flex-wrap:nowrap;white-space:nowrap}
        .opts label{display:flex;gap:6px;align-items:center}
        .controls label{font-size:12px;color:#333}
        .controls input{width:100%;padding:10px 12px;border:1px solid var(--beige);border-radius:8px;background:#fff}
        .actions{display:flex;gap:12px;margin-top:8px}
        button.primary{background:var(--red);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
        button.secondary{background:#fff;color:#000;border:1px solid var(--beige);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
        .muted{color:#555;font-size:12px}
        .progress{height:10px;background:var(--beige);border-radius:999px;overflow:hidden}
        .bar{height:100%;width:0;background:var(--red);transition:width .4s ease}
        .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
        .kpi{background:linear-gradient(180deg,#fff,#faf8ef);border:1px solid var(--beige);border-radius:12px;padding:12px}
        .kpi .label{font-size:12px;color:#333}
        .kpi .value{font-size:22px;font-weight:800}
        .kpis-lite .kpi .value{font-weight:400}
        .section{margin-top:12px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        @media(max-width:960px){.row{grid-template-columns:1fr}}
        .placeholder{display:flex;align-items:center;justify-content:center;height:100%;min-height:280px;border:1px dashed var(--beige);border-radius:12px;background:#fff;color:#333}
        .hero{display:none}
        .logs{background:#0b0b0b;color:#e5e5e5;border:1px solid #2a2a2a;border-radius:8px;padding:8px;max-height:200px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
        .link{color:#000;text-decoration:none;border-bottom:1px dashed var(--beige)}
        .scroll{max-height:320px;overflow:auto}
        .charts{display:flex;gap:12px;align-items:flex-start;max-width:100%;margin:0 auto;overflow-x:auto;flex-wrap:nowrap}
        .chart-col{display:flex;flex-direction:column;flex:1 1 50%;min-width:520px}
        .charts .chart-wrap{background:#fff;border:1px solid var(--beige);border-radius:10px;padding:8px;min-height:240px;display:flex;align-items:center;position:relative}
        .charts canvas{width:100%!important;height:220px!important}
        .chart-loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:repeating-linear-gradient( 45deg, rgba(226,221,180,.25), rgba(226,221,180,.25) 10px, rgba(255,255,255,.25) 10px, rgba(255,255,255,.25) 20px ); border-radius:10px}
        .chart-spinner{width:24px;height:24px;border:3px solid var(--beige);border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite;background:transparent}
        .legend{display:grid;grid-template-columns:1fr;gap:2px;margin-top:2px;font-size:10px;color:#333}
        .legend .item{display:flex;align-items:center;gap:8px}
        .legend .swatch{width:10px;height:10px;border-radius:2px;display:inline-block}
        .callout{background:#fff;border:1px solid var(--beige);border-radius:10px;padding:10px;font-size:12px;color:#333}
        .section-title{font-weight:700;margin:8px 0 4px 0}
        .tested-title{text-align:center}
        /* Nav button styling */
        .nav-btn{display:inline-block;background:#fff;border:1px solid var(--beige);color:#000;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:600;margin-left:8px}
        .nav-btn:hover{background:#faf8ef}
        .nav-btn.primary{background:var(--red);color:#fff;border-color:var(--red)}
        /* Mode selection */
        .mode-selection {
            margin: 12px 0;
        }
        .radio-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .radio-group input[type="radio"] {
            width: auto;
        }

        /* Options */
        .options {
            margin: 12px 0;
        }
        .options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .options input[type="checkbox"] {
            width: auto;
        }

        /* Results panel */
        .results-panel {
            margin-top: 24px;
        }
        .result-item {
            background: #fff;
            border: 1px solid var(--beige);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .result-item.pass {
            border-left: 4px solid #4caf50;
        }
        .result-item.fail {
            border-left: 4px solid #f44336;
        }
        .result-item.bug {
            border-left: 4px solid #ff9800;
        }
        .result-item h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        .result-item small {
            color: #666;
            font-size: 12px;
        }

        /* Cancel button styling */
        #cancelBtn {
            display: none;
            background: var(--red);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .top-actions{display:flex;align-items:center;gap:8px;flex-shrink:0;white-space:nowrap}
        .kv-table{width:100%;border-collapse:collapse}
        .kv-table{table-layout:fixed}
        .kv-table td{border-bottom:1px solid var(--beige);padding:6px 8px;font-size:12px;word-break:break-word;white-space:normal}
        .kv-table td:first-child{width:180px;color:#333;font-weight:600}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;border-bottom:1px solid var(--beige);font-size:13px}
        th{text-align:left;color:#333}
        .status{font-weight:700}
        .PASS{color:#15803d}
        .FAIL{color:#b91c1c}
        .BUG{color:#a16207}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--beige);font-size:11px}
        .file{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--beige)}
        .file a{color:#000;text-decoration:none}
        .hidden{display:none !important}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,.06);display:none;align-items:center;justify-content:center;z-index:9999}
        .loader{display:flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--beige);padding:10px 14px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
        .spinner{width:22px;height:22px;border:3px solid var(--beige);border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* Constrain Tested Data section */
        #testedDataWrap{max-width:100%;max-height:50vh;overflow:auto}
        #testedDataTables{max-width:100%;overflow:auto}
        /* Downloads row visibility */
        #downloadsRow{display:none}
    </style>
    <script>
        try { if (window.Chart && window.Chart.register) { Chart.register(ChartDataLabels); } } catch (e) {}
        const fmt = (n)=> new Intl.NumberFormat().format(n||0);
        async function postJSON(url, data){
            const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data||{})});
            return res.json();
        }
        async function getJSON(url){
            const res = await fetch(url);
            return res.json();
        }
        let poller=null, charts={};
        let activeTab='all';
        const esc = (s)=>String(s==null?'':s)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
        async function startRun(){
            const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://127.0.0.1:8000';
            
            // Validate URL format
            try {
                new URL(baseUrl);
            } catch(e) {
                alert('Please enter a valid URL (e.g., http://example.com)');
                return;
            }

            const runBtn = document.getElementById('runBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            // Validate button state
            if (!runBtn || !cancelBtn) {
                console.error('Run or Cancel button not found');
                return;
            }

            // Get test mode
            let testMode = 'full';
            const modeRadios = document.getElementsByName('mode');
            for (const radio of modeRadios) {
                if (radio.checked) {
                    testMode = radio.value;
                    break;
                }
            }

            // Update UI state
            runBtn.style.display = 'none';
            cancelBtn.style.display = 'inline-block';
            runBtn.disabled = true;

            // Update progress indicators
            document.querySelector('.bar').style.width = '1%';
            document.getElementById('progressText').textContent = 'Starting...';
            
            // Show chart loaders
            const l1s = document.getElementById('loadStatus'); 
            if(l1s) l1s.style.display = 'flex';
            const l2s = document.getElementById('loadTypes'); 
            if(l2s) l2s.style.display = 'flex';
            
            // Clear previous results
            const resArea = document.getElementById('resultsArea'); 
            if(resArea) resArea.style.display = 'none';
            const tbody = document.getElementById('tbody'); 
            if(tbody) tbody.innerHTML = '';
            
            // Show loading overlay
            showOverlay(testMode === 'fast' ? 'Starting smoke tests...' : 'Starting full regression...');
            
            try {
                const res = await postJSON('/run', {
                    baseUrl,
                    mode: testMode
                });

                if (!res.ok) { 
                    alert(res.message || 'Unable to start tests'); 
                    runBtn.disabled = false;
                    runBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'none';
                    return; 
                }

                // Start status polling
                pollStatus();
                poller = setInterval(pollStatus, 1200);

                // Safety timeout to re-enable button if status doesn't change
                setTimeout(async () => {
                    try { 
                        const s = await getJSON('/status'); 
                        if (!s.running) {
                            runBtn.disabled = false;
                            runBtn.style.display = 'inline-block';
                            cancelBtn.style.display = 'none';
                        }
                    } catch(e) {
                        runBtn.disabled = false;
                        runBtn.style.display = 'inline-block';
                        cancelBtn.style.display = 'none';
                    }
                }, 8000);

            } catch(err) {
                console.error('Failed to start test run:', err);
                alert('Failed to start test run. Please check your connection and try again.');
                runBtn.disabled = false;
                runBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'none';
            } finally {
                hideOverlay();
            }
        }
        async function pollStatus(){
            const s = await getJSON('/status');
            // Update progress bar
            document.querySelector('.bar').style.width = (s.progress||0)+'%';
            document.getElementById('progressText').textContent = (s.progress||0)+'%';
            
            // If fast mode, show indicator in progress text
            if (s.mode === 'fast' && s.running) {
                document.getElementById('progressText').textContent = `${s.progress||0}% (Fast Mode)`;
            }
            const sum = s.summary||{};
            document.getElementById('kpiTotal').textContent = fmt(sum.total_tests);
            document.getElementById('kpiPass').textContent = fmt(sum.passed);
            document.getElementById('kpiFail').textContent = fmt(sum.failed);
            document.getElementById('kpiBugs').textContent = fmt(sum.bugs_found);
            // progress kpis
            
            // Check for cancelled state
            if (s.status === 'cancelled') {
                document.getElementById('progressText').textContent = 'Cancelled';
                document.getElementById('runBtn').disabled = false;
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('runBtn').style.display = 'inline-block';
                if (poller) {
                    clearInterval(poller);
                    poller = null;
                }
                return;
            }
            
            // Update status with fast mode indicator
            const status = s.running 
                ? (s.mode === 'fast' ? 'Running Smoke Tests' : 'Running Full Tests')
                : (sum.total_tests ? 'Completed' : 'Idle');
            document.getElementById('kpiStatus').textContent = status;
            document.getElementById('kpiQueued').textContent = s.running ? 0 : 0;
            document.getElementById('kpiEta').textContent = s.running ? 'Calculating…' : (sum.execution_time ? `${Math.round(sum.execution_time)}s` : '—');
            const logs = document.getElementById('logsBox'); if(logs && s.errors && s.errors.length){ logs.textContent = s.errors.join('\n'); }
            const allRows = Array.isArray(s.results)?s.results:[];
            window.__allTypes = Array.from(new Set(allRows.map(r=>r['Test Type']).filter(Boolean)));
            const filtered = filterRows(allRows, activeTab);
            renderResults(filtered);
            const areaEl = document.getElementById('resultsArea');
            if(s.running){
                if(areaEl) areaEl.style.display = 'none';
                const dl = document.getElementById('downloadsRow'); if(dl) dl.style.display = 'none';
            } else if(!s.running && allRows.length > 0){
                clearInterval(poller);
                document.getElementById('runBtn').disabled=false;
                refreshReports();
                if(areaEl) areaEl.style.display = 'block';
                const dl = document.getElementById('downloadsRow'); if(dl) dl.style.display = 'flex';
                // ensure charts/results stack under the testing section
                const grid = document.querySelector('.grid');
                if(grid) grid.classList.add('single');
                const right = document.getElementById('emptyRight');
                if(right) right.style.display = 'none';
                // auto-show Tested Data
                const tdCard = document.getElementById('testedDataCard');
                if(tdCard){ tdCard.style.display = 'block'; }
                // load tested data in place without auto-scroll
                try{ showTestedData(false); }catch(e){}
            } else if (areaEl && allRows.length === 0) {
                areaEl.style.display = 'none';
            }
            if(s.errors && s.errors.length){
                document.getElementById('errors').innerHTML = s.errors.map(e=>`<div class="pill">${e}</div>`).join('');
            }
        }
        function filterRows(rows, tab){
            if(tab==='passed') return rows.filter(r=>String(r['Result']).toUpperCase()==='PASS');
            if(tab==='failed') return rows.filter(r=>String(r['Result']).toUpperCase()==='FAIL');
            if(tab==='bugs') return rows.filter(r=>String(r['Result']).toUpperCase()==='BUG');
            if(tab==='weak') return rows.filter(r=>['FAIL','BUG'].includes(String(r['Result']).toUpperCase()));
            return rows;
        }
        function renderResults(rows){
            const tbody = document.getElementById('tbody');
            if(!tbody) return;
            if(!rows.length){
                tbody.innerHTML = `<tr><td colspan="6" class="muted">No results yet. Start a run to see data.</td></tr>`;
                buildCharts([]);
                return;
            }
            tbody.innerHTML = rows.map(r=>`<tr>
                <td>${esc(r['Test Case']||'')}</td>
                <td class="status ${esc(r['Result']||'')}">${esc(r['Result']||'')}</td>
                <td><span class="pill">${esc(r['Test Type']||'')}</span></td>
                <td>${esc(r['Severity']||'')}</td>
                <td class="muted">${esc(r['Timestamp']||'')}</td>
                <td>${esc(r['Details']||'')}</td>
            </tr>`).join('');
            window.__lastRows = rows;
            buildCharts(rows);
        }
        function buildCharts(rows){
            const ctx1 = document.getElementById('chartStatus');
            if(!ctx1) return;
            const counts = {PASS:0, FAIL:0, BUG:0};
            const typeCounts = {};
            rows.forEach(r=>{
                const status = (r['Result']||'').toUpperCase();
                if(counts[status] !== undefined){ counts[status] += 1; }
                const t=(r['Test Type']||'Other');
                typeCounts[t]=(typeCounts[t]||0)+1;
            });
            const statusData = {
                labels:['PASS','FAIL','BUG'],
                datasets:[{data:[counts.PASS||0, counts.FAIL||0, counts.BUG||0], backgroundColor:['#16a34a','#dc2626','#ca8a04']}]
            };
            charts.status && charts.status.destroy();
            charts.status = new Chart(ctx1,{type:'doughnut', data:statusData, options:{
                plugins:{
                    legend:{position:'bottom', labels:{boxWidth:10, font:{size:9}}},
                    tooltip:{callbacks:{
                        label:(ctx)=>`${ctx.label}: ${ctx.parsed} tests`
                    }, bodyFont:{size:9}, titleFont:{size:10}},
                    datalabels:{
                        color:'#000',
                        font:{size:8, weight:'600'},
                        formatter:(v,ctx)=>{
                            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0) || 0;
                            if(!v || total===0) return '';
                            const pct = Math.round((v/total)*100);
                            return pct>0 ? `${pct}%` : '';
                        }
                    }
                },
                layout:{padding:6}
            }});
            const l1done = document.getElementById('loadStatus'); if(l1done) l1done.style.display='none';

            const ctx2 = document.getElementById('chartTypes');
            const baseLabels = (window.__allTypes && window.__allTypes.length)? window.__allTypes : Object.keys(typeCounts);
            const labels = baseLabels.length ? baseLabels : ['UI','API','Forms','Navigation','Security','Performance'];
            const data = labels.map(l=>typeCounts[l]||0);
            const maxVal = data.reduce((m,v)=>Math.max(m, v||0), 0);
            charts.types && charts.types.destroy();
            charts.types = new Chart(ctx2,{type:'bar', data:{labels,datasets:[{label:'Tests', data, backgroundColor:'#E43636'}]}, options:{
                plugins:{
                    legend:{display:false},
                    tooltip:{callbacks:{label:(ctx)=>`${ctx.parsed.y??ctx.parsed} tests`}, bodyFont:{size:9}},
                    datalabels:{
                        anchor:'end', align:'top', offset:4, clamp:true, color:'#000', font:{size:8, weight:'600'}, formatter:(v)=> v>0? v: ''
                    }
                },
                scales:{x:{ticks:{maxRotation:0,minRotation:0, font:{size:9}}}, y:{beginAtZero:true, suggestedMax: maxVal + 1, ticks:{stepSize:1, font:{size:9}}}},
                layout:{padding:{top:8,right:6,bottom:6,left:6}}
            }});
            const l2done = document.getElementById('loadTypes'); if(l2done) l2done.style.display='none';

            // Build simple explanatory legend for types
            const typeLegend = document.getElementById('typeLegend');
            if(typeLegend){
                typeLegend.innerHTML = labels.map((l,i)=>{
                    return `<div class="item"><span class="swatch" style="background:#E43636"></span> ${l}: ${data[i]} tests</div>`;
                }).join('');
            }
            window.__lastSummary = counts;
            window.__lastTypeCounts = typeCounts;
        }
        function setTab(tab){
            activeTab = tab;
            pollStatus();
            document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
            const id = 'tab-'+tab;
            const el = document.getElementById(id);
            if(el){ el.classList.add('active'); }
        }
        function renderKVTable(obj){
            const entries = Object.entries(obj||{});
            if(!entries.length) return '<div class="muted">Empty</div>';
            return '<table class="kv-table">'+entries.map(([k,v])=>`<tr><td>${esc(k)}</td><td>${esc(typeof v==='object'?JSON.stringify(v):String(v))}</td></tr>`).join('')+'</table>';
        }
        function renderDataTable(data){
            // Render arrays/objects into an easy-to-scan table
            if(!data) return '<div class="muted">Empty</div>';
            // If it's an array
            if(Array.isArray(data)){
                if(data.length===0) return '<div class="muted">Empty</div>';
                // Array of strings/numbers
                if(typeof data[0] !== 'object' || data[0] === null){
                    return '<table class="kv-table">'
                        + '<thead><tr><td>#</td><td>Value</td></tr></thead>'
                        + '<tbody>'
                        + data.map((v,i)=>`<tr><td>${i+1}</td><td>${esc(String(v))}</td></tr>`).join('')
                        + '</tbody></table>';
                }
                // Array of objects: build column set
                const cols = Array.from(data.reduce((set,row)=>{
                    Object.keys(row||{}).forEach(k=>set.add(k));
                    return set;
                }, new Set())).sort();
                return '<div class="scroll">'
                    + '<table class="kv-table">'
                    + '<thead><tr>' + cols.map(c=>`<td>${esc(c)}</td>`).join('') + '</tr></thead>'
                    + '<tbody>'
                    + data.map(row=>'<tr>' + cols.map(c=>`<td>${esc(typeof row[c]==='object'?JSON.stringify(row[c]):String(row[c]??''))}</td>`).join('') + '</tr>').join('')
                    + '</tbody></table></div>';
            }
            // Object: key-value
            return renderKVTable(data);
        }
        async function showTestedData(scrollIntoView=true){
            const res = await getJSON('/tested-data');
            const wrap = document.getElementById('testedDataWrap');
            const host = document.getElementById('testedDataTables');
            const card = document.getElementById('testedDataCard');
            if(card) card.style.display = 'block';
            if(!res.ok){ host.innerHTML = '<div class="muted">Unable to load tested data</div>'; wrap.style.display='block'; if(card && scrollIntoView){ card.scrollIntoView({behavior:'smooth'}); } return; }
            const data = res.data||{};
            // Build sections dynamically from available, non-empty data
            const sections = [];
            const addSection = (label, content)=>{
                const isEmptyArray = Array.isArray(content) && content.length===0;
                const isEmptyObject = content && typeof content==='object' && !Array.isArray(content) && Object.keys(content).length===0;
                if(content==null || isEmptyArray || isEmptyObject) return;
                sections.push([label, content]);
            };
            // Legacy fields (if backend provides them)
            addSection('Valid User', data.user_valid);
            addSection('Invalid User', data.user_invalid);
            addSection('Valid Login', data.login_valid);
            addSection('Invalid Login', data.login_invalid);
            addSection('Edge Cases', data.edge);
            addSection('API Payloads', data.api);
            addSection('SQL Payloads', data.sql_payloads);
            addSection('XSS Payloads', data.xss_payloads);
            // New real-run fields
            addSection('Run Summary', data.summary);
            // Show only a sample of results to keep it readable
            if(Array.isArray(data.results) && data.results.length){ addSection('Results (Sample)', data.results.slice(0, 10)); }
            if(Array.isArray(data.weaknesses) && data.weaknesses.length){ addSection('Weaknesses (FAIL/BUG)', data.weaknesses); }
            if(sections.length===0){
                host.innerHTML = '<div class="muted">No tested data available yet. Start a run and check back.</div>';
            } else {
                host.innerHTML = sections.map(([label,content])=>`<div style="margin:8px 0"><div class="section-title tested-title">${esc(label)}</div>${renderDataTable(content)}</div>`).join('');
            }
            wrap.style.display='block';
            if(card && scrollIntoView){ card.scrollIntoView({behavior:'smooth'}); }
        }
        async function refreshReports(){}
        function showOverlay(text){
            const o = document.getElementById('overlay');
            const t = document.getElementById('overlayText');
            if(t) t.textContent = text||'';
            if(o) o.style.display = 'flex';
        }
        function hideOverlay(){
            const o = document.getElementById('overlay');
            if(o) o.style.display = 'none';
        }
        async function exportResults(format){
            const res = await fetch('/export',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({format:format==='excel'?'excel':'csv'})});
            const json = await res.json();
            if(!json.ok){ alert(json.message||'Export failed'); return; }
            window.location.href = `/download?path=${encodeURIComponent(json.path)}`;
        }
        function downloadBlob(filename, blob){
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            setTimeout(()=>URL.revokeObjectURL(url), 1000);
        }
        function downloadJSON(filename, data){
            const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
            downloadBlob(filename, blob);
        }
        function downloadCanvasPNG(canvasId, filename){
            const c = document.getElementById(canvasId);
            if(!c){ alert('Chart not available'); return; }
            const link = document.createElement('a');
            link.href = c.toDataURL('image/png');
            link.download = filename;
            link.click();
        }
        async function cancelRun() {
            try {
                const response = await fetch('/cancel', {
                    method: 'POST'
                });
                if (!response.ok) {
                    alert('Failed to cancel test run');
                }
            } catch (err) {
                console.error('Error cancelling tests:', err);
                alert('Error cancelling tests');
            }
        }

        async function getTestedData(){
            if(window.__testedData) return window.__testedData;
            try{ const res = await getJSON('/tested-data'); if(res && res.ok){ window.__testedData = res.data||{}; } }catch(e){}
            return window.__testedData||{};
        }
        function buildTestedDataRows(data){
            const rows = [];
            const pushRow = (section, key, value)=>{
                let printable = value;
                if(typeof value === 'object') printable = JSON.stringify(value);
                rows.push({Section: section, Key: String(key??''), Value: String(printable??'')});
            };
            const addSection = (sectionName, content)=>{
                if(!content){ return; }
                if(Array.isArray(content)){
                    content.forEach((v,idx)=> pushRow(sectionName, idx+1, v));
                } else if(typeof content === 'object'){
                    Object.entries(content).forEach(([k,v])=> pushRow(sectionName, k, v));
                } else {
                    pushRow(sectionName, '', content);
                }
            };
            addSection('Valid User', data.user_valid);
            addSection('Invalid User', data.user_invalid);
            addSection('Valid Login', data.login_valid);
            addSection('Invalid Login', data.login_invalid);
            addSection('Edge Cases', data.edge);
            addSection('API Payloads', data.api);
            addSection('SQL Payloads', data.sql_payloads);
            addSection('XSS Payloads', data.xss_payloads);
            return rows;
        }
        function rowsToCSV(rows){
            if(!rows || !rows.length) return 'Section,Key,Value\n';
            const escCSV = (s)=>`"${String(s).replace(/"/g,'""')}"`;
            const header = 'Section,Key,Value\n';
            const body = rows.map(r=>[r.Section,r.Key,r.Value].map(escCSV).join(',')).join('\n');
            return header + body + '\n';
        }
        function exportResultsOverview(){
            try{ downloadCanvasPNG('chartStatus','results_status.png'); }catch(e){}
            try{ downloadCanvasPNG('chartTypes','results_types.png'); }catch(e){}
            const summary = window.__lastSummary || {};
            const types = window.__lastTypeCounts || {};
            downloadJSON('results_overview_summary.json', {summary, typeCounts: types, generatedAt: new Date().toISOString()});
        }
        async function exportLatestResultsCSV(){ exportResults('csv'); }
        async function exportLatestResultsExcel(){ exportResults('excel'); }
        async function exportTestedDataJSON(){
            const data = await getTestedData();
            downloadJSON('tested_data.json', {data, generatedAt: new Date().toISOString()});
        }
        async function exportTestedDataCSV(){
            const data = await getTestedData();
            const rows = buildTestedDataRows(data);
            const csv = rowsToCSV(rows);
            downloadBlob('tested_data.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
        }
        async function exportTestedDataExcel(){
            // Provide Excel-friendly CSV for broad compatibility
            const data = await getTestedData();
            const rows = buildTestedDataRows(data);
            const csv = rowsToCSV(rows);
            downloadBlob('tested_data.xlsx', new Blob([csv], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
        }
        async function exportAll(){
            const bundle = {
                generatedAt: new Date().toISOString(),
                summary: window.__lastSummary || {},
                typeCounts: window.__lastTypeCounts || {},
                results: window.__lastRows || [],
                testedData: window.__testedData || null,
                charts: {}
            };
            try{ const c1 = document.getElementById('chartStatus'); if(c1) bundle.charts.statusPNG = c1.toDataURL('image/png'); }catch(e){}
            try{ const c2 = document.getElementById('chartTypes'); if(c2) bundle.charts.typesPNG = c2.toDataURL('image/png'); }catch(e){}
            downloadJSON('qassurify_bundle.json', bundle);
        }
        async function exportAllDoc(){
            // Ensure we have the latest tested data
            const tested = await getTestedData();
            const summary = window.__lastSummary || {};
            const typeCounts = window.__lastTypeCounts || {};
            const results = window.__lastRows || [];
            const imgStatus = (()=>{ try{ const c = document.getElementById('chartStatus'); return c? c.toDataURL('image/png'): null; }catch(e){ return null; }})();
            const imgTypes = (()=>{ try{ const c = document.getElementById('chartTypes'); return c? c.toDataURL('image/png'): null; }catch(e){ return null; }})();
            const escapeHtml = (s)=> String(s==null?'':s)
                .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const renderKV = (obj)=>{
                const rows = Object.entries(obj||{}).map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(typeof v==='object'?JSON.stringify(v):String(v))}</td></tr>`).join('');
                return `<table class="kv"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>${rows||'<tr><td colspan="2">—</td></tr>'}</tbody></table>`;
            };
            const renderResultsTable = (rows)=>{
                const head = '<tr><th>Test Case</th><th>Status</th><th>Type</th><th>Severity</th><th>Time</th><th>Details</th></tr>';
                const body = (rows||[]).map(r=>`<tr>
                    <td>${escapeHtml(r['Test Case']||'')}</td>
                    <td>${escapeHtml(r['Result']||'')}</td>
                    <td>${escapeHtml(r['Test Type']||'')}</td>
                    <td>${escapeHtml(r['Severity']||'')}</td>
                    <td>${escapeHtml(r['Timestamp']||'')}</td>
                    <td>${escapeHtml(r['Details']||'')}</td>
                </tr>`).join('');
                return `<table class="grid"><thead>${head}</thead><tbody>${body||'<tr><td colspan="6">No results</td></tr>'}</tbody></table>`;
            };
            const renderSectionTable = (title, content)=>{
                const renderData = (data)=>{
                    if(!data) return '<div class="muted">Empty</div>';
                    if(Array.isArray(data)){
                        if(data.length===0) return '<div class="muted">Empty</div>';
                        if(typeof data[0] !== 'object' || data[0] === null){
                            return '<table class="kv"><thead><tr><th>#</th><th>Value</th></tr></thead><tbody>'+
                                data.map((v,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(String(v))}</td></tr>`).join('')+
                                '</tbody></table>';
                        }
                        const cols = Array.from(data.reduce((set,row)=>{ Object.keys(row||{}).forEach(k=>set.add(k)); return set; }, new Set())).sort();
                        return '<div class="scroll"><table class="kv"><thead><tr>'+cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')+'</tr></thead><tbody>'+
                            data.map(row=>'<tr>'+cols.map(c=>`<td>${escapeHtml(typeof row[c]==='object'?JSON.stringify(row[c]):String(row[c]??''))}</td>`).join('')+'</tr>').join('')+
                            '</tbody></table></div>';
                    }
                    // object
                    const rows = Object.entries(data||{}).map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(typeof v==='object'?JSON.stringify(v):String(v))}</td></tr>`).join('');
                    return `<table class="kv"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>${rows||'<tr><td colspan="2">Empty</td></tr>'}</tbody></table>`;
                };
                return `<h3>${escapeHtml(title)}</h3>${renderData(content)}`;
            };
            const testedSections = [
                ['Valid User', tested.user_valid],
                ['Invalid User', tested.user_invalid],
                ['Valid Login', tested.login_valid],
                ['Invalid Login', tested.login_invalid],
                ['Edge Cases', tested.edge],
                ['API Payloads', tested.api],
                ['SQL Payloads', tested.sql_payloads],
                ['XSS Payloads', tested.xss_payloads]
            ].map(([t,c])=>renderSectionTable(t,c)).join('');

            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>QAssurify Report</title>
            <style>
                body{font-family:Arial,Helvetica,sans-serif;color:#111}
                h1{margin:0 0 8px 0}
                h2{margin:16px 0 6px 0}
                h3{margin:12px 0 6px 0}
                .muted{color:#555}
                .section{margin:10px 0}
                table{border-collapse:collapse;width:100%}
                table.kv th, table.kv td, table.grid th, table.grid td{border:1px solid #ddd;padding:6px 8px;vertical-align:top;word-break:break-word}
                thead th{background:#f5f5f5}
                .charts{display:flex;gap:10px}
                .chart{flex:1 1 50%}
                img.chart{max-width:100%;height:auto;border:1px solid #eee}
            </style></head><body>
                <h1>QAssurify — Download All Report</h1>
                <div class="section"><div class="muted">Generated at ${escapeHtml(new Date().toLocaleString())}</div></div>

                <h2>1. Summary</h2>
                ${renderKV(summary)}

                <h2>2. Results Overview</h2>
                <div class="charts">
                    <div class="chart">
                        <h3>Status Distribution</h3>
                        ${imgStatus? `<img class="chart" src="${imgStatus}" alt="Status Chart"/>` : '<div class="muted">Chart unavailable</div>'}
                    </div>
                    <div class="chart">
                        <h3>Tests by Type</h3>
                        ${imgTypes? `<img class="chart" src="${imgTypes}" alt="Types Chart"/>` : '<div class="muted">Chart unavailable</div>'}
                    </div>
                </div>
                <h3>Type Counts</h3>
                ${renderKV(typeCounts)}

                <h2>3. Latest Results</h2>
                ${renderResultsTable(results)}

                <h2>4. Tested Data</h2>
                ${testedSections || '<div class="muted">No tested data</div>'}

            </body></html>`;
            downloadBlob('qassurify_report.doc', new Blob([html], {type:'application/msword;charset=utf-8'}));
        }
        function applySelectTooltip(selectEl, descriptions){
            if(!selectEl) return;
            // assign titles to options
            Array.from(selectEl.options||[]).forEach(opt=>{
                const key = String(opt.value||'').toLowerCase();
                if(descriptions[key]) opt.title = descriptions[key];
            });
            // set select title based on current value
            const setTitle = ()=>{
                const key = String(selectEl.value||'').toLowerCase();
                selectEl.title = descriptions[key] || '';
            };
            selectEl.addEventListener('change', setTitle);
            setTitle();
        }
        function navGo(id){
            const el = document.getElementById(id);
            if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
        }
        function navTab(tab){
            setTab(tab);
            const el = document.getElementById('latestResults');
            if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
        }
        window.addEventListener('DOMContentLoaded',()=>{
            refreshReports();
            const area = document.getElementById('resultsArea'); if(area) area.style.display = 'none';
            // default to single-column centered layout with equal side padding
            const grid = document.querySelector('.grid');
            if(grid) grid.classList.add('single');
            const right = document.getElementById('emptyRight');
            if(right) right.style.display = 'none';

            // Descriptions for select options
            const testTypeDesc = {
                'e2e': 'End‑to‑end: full user flows across the UI and backend.',
                'smoke': 'Smoke: quick checks of critical paths to catch obvious breaks.',
                'integration': 'Integration: verifies interactions between components/services.'
            };
            const envDesc = {
                'qa': 'QA: internal testing environment with test data.',
                'staging': 'Staging: pre‑production environment mirroring prod.',
                'prod': 'Production: live environment — use with caution.'
            };
            applySelectTooltip(document.getElementById('testType'), testTypeDesc);
            applySelectTooltip(document.getElementById('env'), envDesc);

            // Sidebar toggle
            const nav = document.getElementById('sideNav');
            const toggle = document.getElementById('navToggle');
            const main = document.getElementById('mainContainer');
            const headerEl = document.querySelector('header');
            const setMainPadding = ()=>{
                if(!nav || !main) return;
                const isCollapsed = nav.classList.contains('collapsed');
                const wide = window.innerWidth > 960;
                if(!isCollapsed && wide){
                    main.classList.add('with-sidenav');
                    if(headerEl) headerEl.classList.add('header-offset');
                } else {
                    main.classList.remove('with-sidenav');
                    if(headerEl) headerEl.classList.remove('header-offset');
                }
                // Keep title from shifting by reserving space for actions
                try{
                    const brand = document.querySelector('.brand');
                    const actions = document.querySelector('.top-actions');
                    if(brand && actions){
                        // Ensure actions remain aligned and visible
                        actions.style.maxWidth = '100%';
                    }
                }catch(e){}
            };
            if(toggle){
                toggle.addEventListener('click',()=>{
                    nav.classList.toggle('collapsed');
                    setMainPadding();
                    // sync header hamburger visibility
                    updateHeaderHamburgerVisibility();
                });
            }
            // Header hamburger should control the same sidebar
            const headerToggle = document.getElementById('headerNavToggle');
            if(headerToggle){
                headerToggle.addEventListener('click',()=>{
                    if(nav){ nav.classList.toggle('collapsed'); }
                    setMainPadding();
                    updateHeaderHamburgerVisibility();
                });
            }
            // Helper toggler for header hamburger (hide when nav is open)
            function updateHeaderHamburgerVisibility(){
                try{
                    const isCollapsed = nav && nav.classList.contains('collapsed');
                    if(headerToggle){
                        if(isCollapsed){ headerToggle.classList.remove('hidden'); }
                        else { headerToggle.classList.add('hidden'); }
                    }
                }catch(e){}
            }
            setMainPadding();
            updateHeaderHamburgerVisibility();

            // Position sidebar below sticky header exactly
            const header = document.querySelector('header');
            const adjustNav = ()=>{
                const h = header ? header.getBoundingClientRect().height : 60;
                if(nav){
                    nav.style.top = h + 'px';
                    nav.style.height = `calc(100vh - ${h}px)`;
                }
                // ensure header remains above sidebar
                if(header){ header.style.zIndex = 10; }
            };
            adjustNav();
            window.addEventListener('resize', ()=>{ adjustNav(); setMainPadding(); });
        });
    </script>
</head>
<body>
    <div id="overlay" class="overlay">
        <div class="loader"><div class="spinner"></div><div id="overlayText">Working...</div></div>
    </div>
    <div class="side-nav collapsed" id="sideNav">
        <button class="toggle" id="navToggle" title="Show/Hide navigation">☰</button>
        <h4>Navigate</h4>
        <a href="#" onclick="navGo('testingSection')">Testing</a>
        <a href="#" onclick="navGo('resultsOverview')">Results Overview</a>
        <a href="#" onclick="navGo('latestResults')">Latest Results</a>
        <a href="#" onclick="navGo('testedDataCard')">Tested Data</a>
        <hr/>
        <a href="#" onclick="exportAllDoc()">Download All</a>
    </div>
    <div class="container" id="mainContainer">
        <header>
            <div class="brand">
                <button id="headerNavToggle" class="hamburger-btn" title="Show/Hide navigation" aria-label="Toggle navigation">
                    <span class="hamburger-lines"><span></span><span></span><span></span></span>
                </button>
                <div class="logo">QA</div>
                <div class="title">QAssurify — Quality Assurance Command Center</div>
            </div>
            <nav class="top-actions">
                <a href="/" class="nav-btn primary">Dashboard</a>
                <a href="/history" class="nav-btn">History</a>
                <a href="/insights" class="nav-btn">Insights</a>
            </nav>
        </header>

        <div class="grid">
            <div style="display:flex; justify-content:center; align-items:flex-start; flex-direction:column">
                <div class="card" id="testingSection" style="margin-top:0; align-self:stretch; width:100%">
                <h3>Testing</h3>
                <div class="body">
                    <div class="controls">
                        <div>
                            <label title="Root address of the app under test. Example: http://127.0.0.1:8000">Base URL</label>
                            <input id="baseUrl" placeholder="http://127.0.0.1:8000" title="Root address of the app under test." />
                        </div>
                        <div>
                            <label title="Scope of tests to run.">Test Type</label>
                            <select id="testType" title="Choose E2E, Smoke, or Integration tests." style="width:100%;padding:10px 12px;border:1px solid var(--beige);border-radius:8px;background:#fff">
                                <option value="e2e" selected>E2E (Full)</option>
                                <option value="smoke">Smoke</option>
                                <option value="integration">Integration</option>
                            </select>
                        </div>
                        <div>
                            <label title="Target deployment environment.">Environment</label>
                            <select id="env" title="Select QA, Staging, or Production." style="width:100%;padding:10px 12px;border:1px solid var(--beige);border-radius:8px;background:#fff">
                                <option value="qa" selected>QA</option>
                                <option value="staging">Staging</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                        <div>
                            <label title="Extra settings for the run. Hover each item to learn more.">Options</label>
                            <div class="opts">
                                <label title="Capture detailed step-by-step logs during execution. Helpful for debugging; can slightly increase runtime."><input id="optLogs" type="checkbox" checked /> Run with logs</label>
                                <label title="Run API-level checks alongside UI tests to validate endpoints, payloads, and responses."><input id="optApi" type="checkbox" checked /> Include API checks</label>
                                <label title="Include lightweight security probes for common issues like XSS/SQL injection payloads."><input id="optSecurity" type="checkbox" /> Security tests</label>
                            </div>
                        </div>
                        <!-- Downloads moved below progress and shown after run finishes -->
                    </div>
                    <div class="actions" style="flex-wrap:wrap">
                        <div class="opts">
                            <label title="Run only critical smoke tests">
                                <div class="mode-selection">
                                    <div class="radio-group">
                                        <label title="Quick core tests">
                                            <input type="radio" name="mode" value="fast" />
                                            Fast
                                        </label>
                                        <label title="Essential smoke tests">
                                            <input type="radio" name="mode" value="smoke" />
                                            Smoke
                                        </label>
                                        <label title="Integration tests">
                                            <input type="radio" name="mode" value="integration" />
                                            Integration
                                        </label>
                                        <label title="Full test suite">
                                            <input type="radio" name="mode" value="full" checked />
                                            Full E2E
                                        </label>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <button id="runBtn" class="primary" title="Begin the selected test run" onclick="startRun()">Start Tests</button>
                        <button id="cancelBtn" class="primary" title="Cancel the current test run" onclick="cancelRun()" style="display: none; background: var(--red);">Cancel Tests</button>
                        <button class="secondary" title="Refresh current status and data" aria-label="Refresh" onclick="pollStatus()">🔄</button>
                    </div>
                    <div class="section">
                        <div class="kpis kpis-lite" style="grid-template-columns:1fr 1fr 1fr">
                            <div class="kpi" title="How many tests are waiting to start running."><div class="label">Tests queued</div><div id="kpiQueued" class="value">0</div></div>
                            <div class="kpi" title="Estimated time remaining to complete the current test run."><div class="label">Expected run time</div><div id="kpiEta" class="value">—</div></div>
                            <div class="kpi" title="Current state of the runner: Idle, Running, or Completed."><div class="label">Status</div><div id="kpiStatus" class="value">Idle</div></div>
                        </div>
                    </div>
                    <details id="liveLogs" class="section" style="margin-top:8px"><summary title="Real-time messages produced while tests run">Live logs</summary>
                        <div id="logsBox" class="logs"></div>
                    </details>
                    <div class="section">
                        <div class="progress" title="Overall test progress"><div class="bar"></div></div>
                        <div class="muted" id="progressText" style="margin-top:6px" title="Completion percentage">0%</div>
                        <div id="downloadsRow" style="display:flex; gap:8px; align-items:center; margin-top:8px">
                            <button class="secondary" title="Export results as a comma-separated values file" onclick="exportResults('csv')">Download CSV</button>
                            <button class="secondary" title="Export results as an Excel workbook" onclick="exportResults('excel')">Download Excel</button>
                        </div>
                    </div>

                    <div class="section kpis">
                        <div class="kpi"><div class="label">Total Tests</div><div id="kpiTotal" class="value">0</div></div>
                        <div class="kpi"><div class="label">Passed</div><div id="kpiPass" class="value PASS">0</div></div>
                        <div class="kpi"><div class="label">Failed</div><div id="kpiFail" class="value FAIL">0</div></div>
                        <div class="kpi"><div class="label">Bugs</div><div id="kpiBugs" class="value BUG">0</div></div>
                    </div>

                    <div class="section">
                        <div id="errors" title="Issues encountered while running tests"></div>
                    </div>
                </div>
            </div>
            <div>
                <div id="emptyRight" class="placeholder">No results yet. Run your first test to see analytics here.</div>
            </div>
        </div>

        <div id="resultsArea" class="section" style="margin-top:12px; display:none">
            <div class="card" id="resultsOverview">
                <h3 title="High-level visuals that summarize your selected results" style="display:flex;align-items:center;justify-content:space-between">Results Overview <span><button class="secondary" title="Download charts + summary" onclick="exportResultsOverview()">Download</button></span></h3>
                <div class="body">
                        <div class="callout" title="Quick explanation of what each chart shows">These visuals summarize the selected test results. The left chart shows the share of Passed, Failed, and Bugs. The right chart shows how many tests ran in each category (e.g., UI, API). Switch tabs below to focus the view.</div>
                        <div class="charts">
                            <div class="chart-col">
                                <div class="chart-wrap" title="Distribution of test outcomes (Pass/Fail/Bug)">
                                    <div id="loadStatus" class="chart-loading"><div class="chart-spinner"></div></div>
                                    <canvas id="chartStatus"></canvas>
                                </div>
                                <div class="legend">
                                <div class="item"><span class="swatch" style="background:#16a34a"></span> Passed: tests that met all checks</div>
                                <div class="item"><span class="swatch" style="background:#dc2626"></span> Failed: tests that did not meet expected behavior</div>
                                <div class="item"><span class="swatch" style="background:#ca8a04"></span> Bugs: confirmed product defects found</div>
                                </div>
                            </div>
                            <div class="chart-col">
                                <div class="chart-wrap" title="Number of tests per category (e.g., UI, API)">
                                    <div id="loadTypes" class="chart-loading"><div class="chart-spinner"></div></div>
                                    <canvas id="chartTypes"></canvas>
                                </div>
                                <div class="legend" id="typeLegend" title="Legend explaining category counts"></div>
                            </div>
                        </div>
                        <div class="section tabs" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                            <button id="tab-all" class="secondary" title="Show all results" onclick="setTab('all')">All</button>
                            <button id="tab-passed" class="secondary" title="Show only passed tests" onclick="setTab('passed')">Passed</button>
                            <button id="tab-failed" class="secondary" title="Show only failed tests" onclick="setTab('failed')">Failed</button>
                            <button id="tab-bugs" class="secondary" title="Show only bugs" onclick="setTab('bugs')">Bugs</button>
                            <button id="tab-weak" class="secondary" title="Show failures + bugs" onclick="setTab('weak')">Weak Areas</button>
                        </div>
                    </div>
                </div>

                <div class="card" id="latestResults" style="margin-top:12px">
                    <h3 title="The most recent individual test outcomes" style="display:flex;align-items:center;justify-content:space-between">Latest Results <span><button class="secondary" title="Download CSV" onclick="exportLatestResultsCSV()">CSV</button> <button class="secondary" title="Download Excel" onclick="exportLatestResultsExcel()">Excel</button></span></h3>
                    <div class="body">
                        <div class="scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th title="Name or description of the test case">Test Case</th>
                                        <th title="Result: PASS, FAIL, or BUG">Status</th>
                                        <th title="Category of the test (UI, API, etc.)">Type</th>
                                        <th title="Impact level if the test fails">Severity</th>
                                        <th title="Execution timestamp">Time</th>
                                        <th title="Additional context or messages">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Tested Data moved below Latest Results -->
                <div class="card" id="testedDataCard" style="margin-top:12px; display:none">
                    <h3 title="Representative examples of data used in tests" style="display:flex;align-items:center;justify-content:space-between">Tested Data <span>
                        <button class="secondary" title="Download Tested Data JSON" onclick="exportTestedDataJSON()">JSON</button>
                        <button class="secondary" title="Download Tested Data CSV" onclick="exportTestedDataCSV()">CSV</button>
                        <button class="secondary" title="Download Tested Data Excel" onclick="exportTestedDataExcel()">Excel</button>
                    </span></h3>
                    <div class="body">
                        <div id="testedDataWrap" class="callout" style="margin-top:0">
                            <div id="testedDataHelp" class="muted" style="margin-bottom:6px">Representative samples of inputs used during testing. Sensitive values are synthetic.</div>
                            <div id="testedDataTables"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer style="text-align:center; margin:16px 0; font-size:12px; color:#555">
        © 2025 Kinjal Luhar • <a href="mailto:kinjal96luhar@gmail.com" class="link">kinjal96luhar@gmail.com</a>
    </footer>
</body>
</html>


